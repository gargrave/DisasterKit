/* disaster_kit | built on 2015/9/14 */!function(){"use strict";angular.module("dk",["ngMessages","ui.router"]).config(["$interpolateProvider","$httpProvider","$stateProvider","$urlRouterProvider",function($interpolateProvider,$httpProvider,$stateProvider,$urlRouterProvider){$interpolateProvider.startSymbol("{A"),$interpolateProvider.endSymbol("A}"),$stateProvider.state("dk",{url:"","abstract":!0}).state("dk.item_list",{url:"/items/:forceUpdate",views:{"item_list@":{controller:"ItemListCtrl as itemListCtrl",templateUrl:"/static/app/items/list/item-list.html"}}}).state("dk.item_detail",{url:"/items/detail/:id",views:{"item_detail@":{controller:"ItemDetailCtrl as itemDetailCtrl",templateUrl:"/static/app/items/detail/item-detail.html"}}}).state("dk.item_create",{url:"/items/add/",views:{"item_create@":{controller:"ItemCreateCtrl as itemCreateCtrl",templateUrl:"/static/app/items/create/item-create.html"}}}).state("dk.item_update",{url:"/items/update/:id",views:{"item_update@":{controller:"ItemUpdateCtrl as itemUpdateCtrl",templateUrl:"/static/app/items/update/item-update.html"}}}).state("dk.category_list",{url:"/categories/",views:{"category_list@":{controller:"CategoryListCtrl as catCtrl",templateUrl:"/static/app/categories/list/category-list.html"}}}),$urlRouterProvider.otherwise("/items/"),$httpProvider.defaults.xsrfCookieName="csrftoken",$httpProvider.defaults.xsrfHeaderName="X-CSRFToken",$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";var param=function(obj){var name,value,fullSubName,subName,subValue,innerObj,i,query="";for(name in obj)if(value=obj[name],value instanceof Array)for(i=0;i<value.length;++i)subValue=value[i],fullSubName=name+"["+i+"]",innerObj={},innerObj[fullSubName]=subValue,query+=param(innerObj)+"&";else if(value instanceof Object)for(subName in value)subValue=value[subName],fullSubName=name+"["+subName+"]",innerObj={},innerObj[fullSubName]=subValue,query+=param(innerObj)+"&";else void 0!==value&&null!==value&&(query+=encodeURIComponent(name)+"="+encodeURIComponent(value)+"&");return query.length?query.substr(0,query.length-1):query};$httpProvider.defaults.transformRequest=[function(data){return angular.isObject(data)&&"[object File]"!==String(data)?param(data):data}]}])}(),function(){"use strict";angular.module("dk").controller("MainCtrl",[function(){var vm=this;vm["class"]={SIXCOLS:"six columns offset-by-three"}}])}(),function(){"use strict";angular.module("dk").controller("CategoryListCtrl",["$http","$stateParams","categoryListSvc","categoryUpdateSvc",function($http,$stateParams,categoryListSvc,categoryUpdateSvc){function loadCategories(force){vm.loading=!0,categoryListSvc.getCategoryList(force).then(function(res){vm.cats=res.cats,vm.subcats=res.subcats,vm.loading=!1})}var vm=this;vm.loading=!0,vm.cats=[],vm.subcats=[],vm.edit={id:-1,name:""},vm.editOriginalName="",vm.newCategory="",vm.errors={duplicate:!1},vm.newCatKeyUp=function(){vm.errors.duplicate=!1,_.each(vm.cats,function(element){return element.name===vm.newCategory?vm.errors.duplicate=!0:void 0})},vm.clearCategoryInput=function(){vm.newCategory="",vm.errors.duplicate=!1},vm.addNewCategory=function(){vm.errors.duplicate||confirm('Create new category "'+vm.newCategory+'"?')&&$http.post("items/api/create_category",{name:vm.newCategory}).then(function(res){vm.clearCategoryInput(),loadCategories(!0)})},vm.enableEditing=function(catID){vm.edit.id=-1,_.each(vm.cats,function(element){return element.id===catID?(vm.edit.name=element.name,vm.editOriginalName=vm.edit.name,vm.edit.id=catID):void 0})},vm.saveEdits=function(){vm.canSaveEdits()&&categoryUpdateSvc.saveEdits(vm.edit,function(){vm.cancelEditing(),loadCategories(!0)})},vm.cancelEditing=function(){vm.edit.id=-1},vm.isEditing=function(catID){return-1!==vm.edit.id&&catID===vm.edit.id},vm.canSaveEdits=function(){return""!==vm.edit.name&&vm.edit.name!==vm.editOriginalName},vm.deleteCategory=function(cat){confirm('Delete category "'+cat.name+'"?')&&$http.post("items/api/delete_category",{pk:cat.id}).then(function(res){loadCategories(!0)})},function(){loadCategories(!1)}()}])}(),function(){"use strict";angular.module("dk").service("categoryListSvc",["$http","$q","$state",function($http,$q,$state){var vm=this,combined={};vm.getCategoryList=function(forceUpdate){var force=forceUpdate||!1,deferred=$q.defer();return combined.cats&&combined.subcats&&!force?deferred.resolve(combined):$http.get("items/api/get_categories").then(function(res){combined={cats:res.data.cats,subcats:res.data.subcats},deferred.resolve(combined)},function(res){alert("There was an error getting the categories list from the server.\nStatus code: "+res.status),$state.go("dk.home")}),deferred.promise}}])}(),function(){"use strict";angular.module("dk").service("categoryUpdateSvc",["$http",function($http){var API_URL_UPDATE="items/api/update_category",vm=this;vm.saveEdits=function(item,callback){$http.post(API_URL_UPDATE,item).then(function(res){callback&&callback()})}}])}(),function(){"use strict";angular.module("dk").directive("categoryRow",[function(){return{restrict:"A",scope:{cat:"=",ctrl:"="},templateUrl:"/static/app/categories/row/category-row.html"}}])}(),function(){"use strict";angular.module("dk").controller("ItemCreateCtrl",["$scope","$http","$state","categoryListSvc","itemCreateSvc",function($scope,$http,$state,categoryListSvc,itemCreateSvc){var vm=this;vm.loading=!0,vm.item={},vm.cats=[],vm.subcats=[],vm.load=function(){categoryListSvc.getCategoryList().then(function(res){vm.cats=res.cats,vm.subcats=res.subcats,vm.item.cat=vm.cats[0],vm.item.subcat=vm.subcats[0],vm.loading=!1})},vm.saveNewItem=function(){$scope.submitted=!1,$scope.createForm.$valid?(vm.item.notes=vm.item.notes||"",itemCreateSvc.saveNewItem(vm.item,function(){$state.go("dk.item_list",{forceUpdate:!0})})):$scope.createForm.submitted=!0},function(){vm.load()}()}])}(),function(){"use strict";angular.module("dk").service("itemCreateSvc",["$http",function($http){var URL_CREATE_ITEM="items/api/create_item/",vm=this;vm.saveNewItem=function(item,callback){$http.post(URL_CREATE_ITEM,item).then(function(res){callback&&callback()},function(res){alert("There was an error when attempting to create this items.\nStatus code: "+res.status),$state.go("dk.item_list")})}}])}(),function(){"use strict";angular.module("dk").controller("ItemDetailCtrl",["$http","$state","$stateParams","itemListSvc",function($http,$state,$stateParams,itemListSvc){var vm=this;vm.loading=!0,vm.item={},vm.updateDetailedItem=function(){itemListSvc.getItemById($stateParams.id).then(function(res){vm.item=res,vm.loading=!1})},vm.deleteItem=function(){confirm("Delete this items?")&&$http["delete"]("items/api/delete_item/"+vm.item.id).then(function(res){$state.go("dk.item_list",{forceUpdate:!0})},function(res){alert("There was an error when attempting to delete this items.\nStatus code: "+res.status),$state.go("dk.item_list")})},function(){vm.updateDetailedItem()}()}])}(),function(){"use strict";angular.module("dk").directive("itemEntryForm",[function(){return{restrict:"A",scope:{ctrl:"=",form:"="},templateUrl:"/static/app/items/form/item-form.html"}}])}(),function(){"use strict";angular.module("dk").controller("ItemListCtrl",["$stateParams","itemListSvc",function($stateParams,itemListSvc){function getDaysUntilExpiration(item){if(!nowRounded){var now=new Date(Date.now());nowRounded=Date.parse(now.getFullYear()+"-"+(now.getMonth()+1)+"-"+now.getDate())}return Math.floor((Date.parse(item.exp)-nowRounded)/MS_IN_DAY)+1}var nowRounded,MS_IN_DAY=864e5,ORDER_OPTIONS=["name","cat","subcat","count","date_added","exp"],vm=this,forceListUpdate=$stateParams.forceUpdate||!1;vm.loading=!0,vm.items=null,vm.ordering="-exp",vm.setOrderBy=function(value){-1!==$.inArray(value,ORDER_OPTIONS)&&(vm.ordering===value?vm.ordering="-"+value:vm.ordering=value)},function(){itemListSvc.getItemList(forceListUpdate).then(function(res){vm.items=res;for(var i in vm.items){var item=vm.items[i];item.timeLeft=getDaysUntilExpiration(item),item.timeLeft<14?item.trClass="danger":item.timeLeft<31?item.trClass="warning":item.trClass="success"}vm.loading=!1})}()}])}(),function(){"use strict";angular.module("dk").service("itemListSvc",["$http","$q","$state",function($http,$q,$state){var vm=this,items=[];vm.getItemList=function(forceUpdate){var deferred=$q.defer(),force=forceUpdate||!1;return items.length>0&&!force?deferred.resolve(items):$http.get("items/api/get_all_items").then(function(res){items=[];var jsonItems=res.data.items;for(var i in jsonItems)jsonItems.hasOwnProperty(i)&&items.push(jsonItems[i]);deferred.resolve(items)},function(res){alert("There was an error getting the items list from the server.\nStatus code: "+res.status),$state.go("dk.home")}),deferred.promise},vm.getItemById=function(targetID){var deferred=$q.defer();return $http.get("items/api/get_item_by_id/"+targetID).then(function(res){deferred.resolve(res.data)},function(res){"404"!=res.status&&alert("There was an error getting the items's details from the server.\nStatus code: "+res.status),$state.go("dk.item_list")}),deferred.promise}}])}(),function(){"use strict";angular.module("dk").directive("itemWidget",[function(){return{restrict:"A",scope:{itemData:"="},templateUrl:"/static/app/items/row/item-row.html"}}])}(),function(){"use strict";angular.module("dk").controller("ItemUpdateCtrl",["$scope","$http","$state","$stateParams","itemListSvc","categoryListSvc",function($scope,$http,$state,$stateParams,itemListSvc,categoryListSvc){function updateLoadingStatus(){vm.item.id&&vm.cats.length>0&&vm.subcats.length>0&&(vm.loading=!1)}var vm=this;vm.loading=!0,vm.item={},vm.cats=[],vm.subcats=[],vm.load=function(){itemListSvc.getItemById($stateParams.id).then(function(res){vm.item=res,updateLoadingStatus()}),categoryListSvc.getCategoryList().then(function(res){vm.cats=res.cats,vm.subcats=res.subcats,updateLoadingStatus()})},vm.commitUpdates=function(){$scope.submitted=!1,$scope.updateForm.$valid?$http.post("items/api/update_item/",vm.item).then(function(res){$state.go("dk.item_list",{forceUpdate:!0})},function(res){alert("There was an error when attempting to update this items.\nStatus code: "+res.status),$state.go("dk.item_list")}):$scope.updateForm.submitted=!0},function(){vm.load()}()}])}();